#!/bin/bash
# Version: 23
# https://techbase.kde.org/Development/Tutorials/Localization/i18n_Build_Systems
# https://techbase.kde.org/Development/Tutorials/Localization/i18n_Build_Systems/Outside_KDE_repositories
# https://invent.kde.org/sysadmin/l10n-scripty/-/blob/master/extract-messages.sh
#
# Step 1: `./bin/i18n extract` to build the i18n template (template.pot)
# Step 2: `./bin/i18n compile` to compile the i18n catalog (i.e. ro.po, de.po, etc.)


set -eEu
. "$( dirname "$0" )/.i18n"


main()
{
    check-gettext-command 'msgfmt'

    local -A modata=()
    store-metadata-in 'modata'

    hint 0 "Compiling translations..." $LINENO
    cd "${modata['poPath']}" || panic 0 "Could not enter '${modata['poPath']}'" $LINENO
    for poFile in $( find . -name '*.po' | sort ); do
        local untranslated locale

        # HACK pcregrep returns exit code 1 if no match found. The ` || true` part mitigates that.
        untranslated="$( pcregrep -Mno1 'msgid "(.+?)".*\nmsgstr ""' "$poFile" )" || true
        if [ -n "$untranslated" ]; then
            warn 1 "$poFile - strings not translated:" $LINENO
            warn 2 "$untranslated"
        else
            hint 1 "$poFile - all translations done. Good job!"
        fi

        locale="$( basename "${poFile%.*}" )"

        msgfmt --output-file="${locale}.mo" "$poFile"

        # https://techbase.kde.org/Development/Tutorials/Localization/i18n_Build_Systems#Declarative_plasmoids
        moFile="${modata['path']}/contents/locale/$locale/LC_MESSAGES/plasma_applet_${modata['id']}.mo"
        mkdir -p "$(dirname "$moFile")"
        mv "$locale.mo" "${moFile}"
    done
    shout 0 '...done compiling translations.' $LINENO
}

main
