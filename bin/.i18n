#!/bin/bash
# Version: 23
# https://techbase.kde.org/Development/Tutorials/Localization/i18n_Build_Systems
# https://techbase.kde.org/Development/Tutorials/Localization/i18n_Build_Systems/Outside_KDE_repositories
# https://invent.kde.org/sysadmin/l10n-scripty/-/blob/master/extract-messages.sh
#
# Step 1: `./bin/i18n-extract` to build the i18n template (template.pot)
# Step 2: `./bin/i18n-compile` to compile the i18n catalog (i.e. ro.po, de.po, etc.)


set -eEu


help()
{
    cat << HELP

i18n  --  process translations for this plasmoid

USAGE:
    i18n ACTION [--restart]

ARGUMENTS
    ACTION      Allowed actions are 'extract' or 'compile'
    --restart   Restarts plasmashell (only with 'mo' argument)

EXAMPLES:
    i18n extract                Extract translatable strings from the source code
    i18n compile                Compile .po translations files into .mo catalog files
    i18n compile --restart      Compile .po translations files into .mo catalog files, then restart plasmashell

HELP
}

show-as()
{
    # https://stackoverflow.com/questions/5947742/how-to-change-the-output-color-of-echo-in-linux
    # https://stackoverflow.com/questions/911168/how-can-i-detect-if-my-shell-script-is-running-through-a-pipe
    # \033[1m   bold
    # \033[94m  lightblue
    # \033[90m  lightgray
    # \033[92m  lightgreen
    # \033[91m  lightred
    # \033[33m  orange
    # \033[31m  red
    # \033[93m  yellow
    local text type modifier reset
    type="$1"
    text="$2"
    if [ -t 1 ]; then # check if output is not a TTY (https://unix.stackexchange.com/questions/401934/how-do-i-check-whether-my-shell-is-running-in-a-terminal#answer-401938)
        case "$type" in
            'info')    modifier='\033[90m';; # light gray
            'warning') modifier='\033[33m';; # orange
            'error')   modifier='\033[31m';; # red
            'success') modifier='\033[92m';; # light green
            'bold')    modifier='\033[1m' ;; # bold
        esac
        [ -n "$modifier" ] && reset='\033[0m'
    fi

    printf "${modifier:-}%s${reset:-}" "${text}"
}

# args: 1 - text
info()    { show-as 'info'    "$1"; }
warning() { show-as 'warning' "$1"; }
error()   { show-as 'error'   "$1"; }
success() { show-as 'success' "$1"; }
bold()    { show-as 'bold'    "$1"; }

say()
{
    local level="$1" text="$2" type="$3" prefix="${4:-}" indent=' '

    for (( i = 0; i < level; i++ )); do indent+='    '; done

    [ -n "$prefix" ] && prefix="[$prefix]"
    prefix="$( printf '%-8s' "$prefix" )"
    text="${text//$'\n'/$'\n'$prefix$indent}"

    info "$prefix"
    printf '%s' "${indent}"
    show-as "$type" "$text"
    echo
}

# args: 1 - indent level, 2 - text, 3 - prefix
hint()  { say "$1" "$2" 'info' "${3:-}"; } # light gray

warn()  { say "$1" "$2" 'warning' "${3:-}"; } # orange

panic() { say "$1" "âŒ $2. Aborting..." 'error' "${3:-}"; exit 1; } # red

shout() { say "$1" "$2" 'success' "${3:-}"; } # light green

check-gettext-command()
{
    local command="$1"

    if [ -z "$( which "$command" )" ]; then
        warn 0 "$command command not found. Need to install gettext." $LINENO
        hint 0 "Running $( bold 'sudo apt install gettext' )..." $LINENO
        sudo apt install gettext
        shout 0 "...done installing gettext." $LINENO
    else
        hint 0 "gettext is installed." $LINENO
    fi
}

update-i18n-metadata()
{
    local file="$1" language="${3:-LANGUAGE}"
    local -n actual="$2"

    sed -i 's/# SOME DESCRIPTIVE TITLE./'"# Translation of ${actual['name']} (${actual['id']}) in $language"'/' "$file"
    sed -i 's/YEAR/'"${actual['year']}"'/' "$file"
    sed -i 's/\(FIRST AUTHOR\|FULL NAME\)/'"${actual['author']}"'/' "$file"
    sed -i 's/EMAIL@ADDRESS/'"${actual['email']}"'/' "$file"
    #sed -i 's/# SOME DESCRIPTIVE TITLE./'"# Translation of ${actual['name']} (${actual['id']}) in $language"'/' "$file"
    #sed -i 's/"Content-Type: text\/plain; charset=CHARSET\\n"/"Content-Type: text\/plain; charset=UTF-8\\n"/' "$file"
}

store-metadata-in()
{
    local plasmoidPath metadata="$1"
    plasmoidPath="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../src" && pwd )"

    local -n metadata
    metadata['path']="$plasmoidPath"
    metadata['poPath']="$plasmoidPath/translate"
    metadata['pot']="${metadata['poPath']}/template.pot"
    {
        read -r metadata['id']
        read -r metadata['name']
        read -r metadata['url']
        read -r metadata['issuesUrl']
        read -r metadata['author']
        read -r metadata['email']
    } < <( jq -r '.KPlugin.Id, .KPlugin.Name, .KPlugin.Website, .KPlugin.BugReportUrl, .KPlugin.Authors[0].Name, .KPlugin.Authors[0].Email' "$plasmoidPath/metadata.json" )

    [ "${metadata['id']+1}" ] || panic 0 "Couldn't read plasmoid ID" $LINENO
    [ "${metadata['issuesUrl']+1}" ] || metadata['issuesUrl']="${metadata['url']}"
}
